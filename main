import os, datetime, requests, pandas as pd
import akshare as ak

WEBHOOK = os.getenv("WEBHOOK_URL")

def fetch_top3():
    df = ak.stock_zh_a_spot_em()
    df = df[~df['åç§°'].str.contains('ST')]
    df = df[df['ä»£ç '].str.match(r'^(600|601|603|605|000|001)')]
    df['æ¶¨è·Œå¹…'] = pd.to_numeric(df['æ¶¨è·Œå¹…'], errors='coerce')
    top3 = df.sort_values('æ¶¨è·Œå¹…', ascending=False).head(3)[['ä»£ç ','åç§°','æ¶¨è·Œå¹…','æœ€æ–°ä»·','å¼€ç›˜','é‡æ¯”','æ€»å¸‚å€¼']]
    return top3

def build_html(top3):
    today = datetime.datetime.now().strftime('%Y-%m-%d %H:%M')
    html = f"""<!DOCTYPE html><html><head><meta charset="utf-8"><title>æ—©ç›˜ç«ä»·Top3</title>
    <style>body{{font-family:Arial;}} table{{border-collapse:collapse;width:100%;}}
    th,td{{border:1px solid #ddd;padding:8px;text-align:center;}}
    th{{background:#f44336;color:white;}}</style></head>
    <body><h2>æ—©ç›˜ç«ä»·Top 3ï¼ˆæ›´æ–°:{today}ï¼‰</h2>
    {top3.to_html(index=False)}
    </body></html>"""
    os.makedirs('docs', exist_ok=True)
    with open('docs/index.html','w',encoding='utf-8') as f:
        f.write(html)

def send_wechat(top3, html_url):
    today = datetime.datetime.now().strftime('%Y-%m-%d')
    lines = [f"ã€ä»Šæ—¥ç«ä»·é€‰è‚¡Top 3ã€‘ï¼ˆ{today}ï¼‰"]
    for idx,row in top3.reset_index(drop=True).iterrows():
        lines.append(f"{idx+1}. {row['åç§°']}ï¼ˆ{row['ä»£ç ']}ï¼‰\\n   æ¶¨å¹…ï¼š{row['æ¶¨è·Œå¹…']}%\\n   æœ€æ–°ä»·ï¼š{row['æœ€æ–°ä»·']}")
    lines.append(f"\\nğŸ”—è¯¦æƒ…ï¼š{html_url}")
    payload = {"msgtype":"markdown","markdown":{"content":"\\n".join(lines)}}
    r = requests.post(WEBHOOK, json=payload, timeout=10)
    r.raise_for_status()

def main():
    top3 = fetch_top3()
    build_html(top3)
    repo = os.getenv('GITHUB_REPOSITORY', '')
    if '/' in repo:
        user, repo_name = repo.split('/',1)
        html_url = f"https://{user}.github.io/{repo_name}/"
    else:
        html_url = ''
    send_wechat(top3, html_url)

if __name__ == "__main__":
    main()
